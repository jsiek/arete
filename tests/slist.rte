type pointer = (some: ?* | null: ⟨⟩);

fun null() -> pointer { return tag null(⟨⟩) as pointer; }
fun is_null(let p : pointer) {
  match (p) {
    case null(t):
      return true;
    case some(q):
      return false;
  }
}
fun some(var p : ?*) -> pointer { return tag some(p) as pointer; }

fun listof(let data) {
  return some(&⟨data, null()⟩);
}

fun push(let data, var list) {
  return some(&⟨data, list⟩);
}

fun data(let node) {
  match (node) {
  case null(w):
    return 0; // raise an exception
  case some(n):
    return (*n)[0];
  }
}

fun next(let node) {
  return (*node)[1];
}

fun is_last(let node) {
  match (node) {
  case null(w):
    return false;
  case some(n):
    return is_null(next(n));
  }
}

// Split the list into two parts, with the second
// part just containing the last element.
fun remove_last(inout n) {
  match (n) {
  case null(q):
    return null();
  case some(inout node):
    if (is_last(next(node))) {
      var q = copy((*node)[1]); // want all permissions to next(n)
      (*node)[1] = null();
      return q;
    } else {
      return remove_last((*n)[1]);
    }
  }
}

fun main() {
  var one_two = push(1, listof(2));
  var two_null = remove_last(one_two);
  let one = data(one_two);
  let two = data(two_null);
  return one + one - two;
}
